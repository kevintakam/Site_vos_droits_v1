{% extends 'base.html.twig' %}
{% block title %}Mon compte{% endblock %}

{% block body %}
<h1>Mon compte</h1>
{% for label, messages in app.flashes %}
  {% for message in messages %}
    <div class="alert alert-{{ label }}">{{ message|raw }}</div>
  {% endfor %}
{% endfor %}

      {% for label, messages in app.flashes %}
        {% for message in messages %}
          <div class="alert alert-{{ label }} text-center">{{ message|raw }}</div>
        {% endfor %}
      {% endfor %}

  <div>
    <h2>
      Mon abonnement
    {% if app.user %}
      <hr class="my-3">
      <form action="{{ path('app_logout') }}" method="post" class="d-inline">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
        <button type="submit" class="btn btn-outline-danger btn-sm">Se déconnecter</button>
      </form>
    {% endif %}

      {% if hasActive %}
        <span class="badge bg-success">Actif</span>
      {% elseif subscription %}
        <span class="badge bg-warning text-dark">Inactif</span>
      {% else %}
        <span class="badge bg-secondary">Aucun</span>
      {% endif %}
    </h2>

        <div class="card shadow-sm border-0 p-4">
          <h2 class="h5 mb-3 fw-semibold text-primary">Mon abonnement
            {% if hasActive %}
              <span class="badge bg-success">Actif</span>
            {% elseif subscription %}
              <span class="badge bg-warning text-dark">Inactif</span>
            {% else %}
              <span class="badge bg-secondary">Aucun</span>
            {% endif %}
          </h2>

          {% if subscription %}
            <p>Statut Stripe : <strong>{{ subscription.status }}</strong></p>
            {% if subscription.currentPeriodEnd %}
              <p>Valide jusqu’au : <strong>{{ subscription.currentPeriodEnd|date('d/m/Y H:i') }}</strong></p>
            {% endif %}
          {% else %}
            <p class="text-muted">Aucun abonnement actif pour l’instant.</p>
          {% endif %}

          {% if stripe.upcomingInvoice %}
            <p class="mt-3">
              Prochaine échéance :
              <strong>{{ (stripe.upcomingInvoice.amount_due / 100)|number_format(2, ',', ' ') }} €</strong>
              le <strong>
                {% if stripe.upcomingInvoice.next_payment_attempt %}
                  {{ stripe.upcomingInvoice.next_payment_attempt|date('d/m/Y H:i') }}
                {% else %}
                  {{ stripe.upcomingInvoice.created|date('d/m/Y H:i') }}
                {% endif %}
              </strong>
            </p>
          {% endif %}

          {% if stripe.default_pm %}
            {% set card = stripe.default_pm.card ?? null %}
            <p>
              Moyen de paiement :
              <strong>{{ card.brand|default('Carte')|capitalize }}</strong>
              — **** **** **** {{ card.last4|default('****') }}
              (exp. {{ '%02d'|format(card.exp_month|default(0)) }}/{{ card.exp_year|default('') }})
            </p>
          {% endif %}

          <div class="mt-3">
            {% if hasActive %}
              <form method="post" action="{{ path('subscription_portal') }}">
                <button class="btn btn-outline-secondary w-100">Gérer mon abonnement</button>
              </form>
            {% elseif subscription %}
              <form method="post" action="{{ path('subscription_checkout') }}">
                <button class="btn btn-primary w-100">Se réabonner</button>
              </form>
            {% else %}
              <form method="post" action="{{ path('subscription_checkout') }}">
                <button class="btn btn-primary w-100">Souscrire</button>
              </form>
            {% endif %}
          </div>

          {% if stripe.invoices is not empty %}
            <h3 class="h6 fw-semibold mt-4 mb-2">Mes dernières factures</h3>
            <ul class="list-unstyled small">
              {% for inv in stripe.invoices %}
                <li class="mb-1">
                  {{ inv.number }} — {{ (inv.total / 100)|number_format(2, ',', ' ') }} €
                  ({{ inv.status }}) — {{ inv.created|date('d/m/Y') }}
                  {% if inv.hosted_invoice_url %}
                    — <a href="{{ inv.hosted_invoice_url }}" target="_blank" rel="noopener">Voir</a>
                  {% endif %}
                  {% if inv.invoice_pdf %}
                    — <a href="{{ inv.invoice_pdf }}" target="_blank" rel="noopener">PDF</a>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </section>

      {% if app.user %}
        <div class="text-center mt-5">
          <a href="{{ path('app_logout') }}" class="btn btn-outline-danger px-5 py-2 fw-semibold">
            <i class="bi bi-box-arrow-right me-1"></i> Se déconnecter
          </a>
        </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}
